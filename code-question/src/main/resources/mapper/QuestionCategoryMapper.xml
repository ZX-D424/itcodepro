<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.mapper.QuestionCategoryMapper">

    <resultMap type="com.ruoyi.domain.QuestionCategory" id="QuestionCategoryResult">
        <result property="id"    column="id"    />
        <result property="parentId"    column="parent_id"    />
        <result property="name"    column="name"    /> <!-- 对应SQL中的c.name -->
        <result property="sort"    column="sort"    />
        <result property="createBy"    column="create_by"    />
        <result property="createTime"    column="create_time"    />
        <result property="updateBy"    column="update_by"    />
        <result property="updateTime"    column="update_time"    />
        <result property="remark"    column="remark"    />
        <result property="parentName" column="parent_name" /> <!-- 对应SQL中的parent_name -->
    </resultMap>

    <!-- 基础查询片段：仅保留SELECT和JOIN，不含ORDER BY，提高复用性 -->
    <sql id="selectQuestionCategoryVo">
        SELECT
        c.id,
        c.parent_id,  <!-- 保留parent_id字段，方便后续条件筛选 -->
        COALESCE(p.name, '顶级类目') AS parent_name,  <!-- 父类名称 -->
        c.name,  <!-- 移除category_name别名，与实体类name属性对应 -->
        c.sort,
        c.create_by,
        c.create_time,
        c.update_by,
        c.update_time,
        c.remark
        FROM
        question_category c
        LEFT JOIN
        question_category p
        ON
        c.parent_id = p.id
    </sql>

    <!-- 列表查询：添加WHERE条件和ORDER BY -->
    <select id="selectQuestionCategoryList" parameterType="com.ruoyi.domain.QuestionCategory" resultMap="QuestionCategoryResult">
        <include refid="selectQuestionCategoryVo"/>
        <where>
            <if test="parentId != null "> and c.parent_id = #{parentId}</if> <!-- 需指定表别名c -->
            <if test="name != null  and name != ''"> and c.name like concat('%', #{name}, '%')</if> <!-- 需指定表别名c -->
            <if test="parentName != null"> and p.name like concat('%', #{parentName}, '%')</if>
        </where>
        ORDER BY  <!-- 排序移到具体查询中 -->
        c.sort ASC,
        c.id ASC;
    </select>

    <!-- 单条查询：添加WHERE条件和ORDER BY（单条可省略排序，按需保留） -->
    <select id="selectQuestionCategoryById" parameterType="Long" resultMap="QuestionCategoryResult">
        <include refid="selectQuestionCategoryVo"/>
        where c.id = #{id}  <!-- 需指定表别名c -->
    </select>
    <select id="selectQuestionCategoryNameList" resultType="java.lang.String">
            select name from question_category where parent_id = 0
    </select>

    <!-- 以下insert/update/delete逻辑无需修改，保持原样 -->
    <insert id="insertQuestionCategory" parameterType="com.ruoyi.domain.QuestionCategory" useGeneratedKeys="true" keyProperty="id">
        insert into question_category
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="parentId != null">parent_id,</if>
            <if test="name != null and name != ''">name,</if>
            <if test="sort != null">sort,</if>
            <if test="createBy != null and createBy != ''">create_by,</if>
            <if test="createTime != null">create_time,</if>
            <if test="updateBy != null">update_by,</if>
            <if test="updateTime != null">update_time,</if>
            <if test="remark != null">remark,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="parentId != null">#{parentId},</if>
            <if test="name != null and name != ''">#{name},</if>
            <if test="sort != null">#{sort},</if>
            <if test="createBy != null and createBy != ''">#{createBy},</if>
            <if test="createTime != null">#{createTime},</if>
            <if test="updateBy != null">#{updateBy},</if>
            <if test="updateTime != null">#{updateTime},</if>
            <if test="remark != null">#{remark},</if>
        </trim>
    </insert>

    <update id="updateQuestionCategory" parameterType="com.ruoyi.domain.QuestionCategory">
        update question_category
        <trim prefix="SET" suffixOverrides=",">
            <if test="parentId != null">parent_id = #{parentId},</if>
            <if test="name != null and name != ''">name = #{name},</if>
            <if test="sort != null">sort = #{sort},</if>
            <if test="createBy != null and createBy != ''">create_by = #{createBy},</if>
            <if test="createTime != null">create_time = #{createTime},</if>
            <if test="updateBy != null">update_by = #{updateBy},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
            <if test="remark != null">remark = #{remark},</if>
        </trim>
        where id = #{id}
    </update>

    <delete id="deleteQuestionCategoryById" parameterType="Long">
        delete from question_category where id = #{id}
    </delete>

    <delete id="deleteQuestionCategoryByIds" parameterType="String">
        delete from question_category where id in
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>
</mapper>


        <!--<?xml version="1.0" encoding="UTF-8" ?>-->
        <!--<!DOCTYPE mapper-->
        <!--PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"-->
        <!--"http://mybatis.org/dtd/mybatis-3-mapper.dtd">-->
        <!--<mapper namespace="com.ruoyi.mapper.QuestionCategoryMapper">-->
        <!--    -->
        <!--    <resultMap type="com.ruoyi.domain.QuestionCategory" id="QuestionCategoryResult">-->
        <!--        <result property="id"    column="id"    />-->
        <!--        <result property="parentId"    column="parent_id"    />-->
        <!--        <result property="name"    column="name"    />-->
        <!--        <result property="sort"    column="sort"    />-->
        <!--        <result property="createBy"    column="create_by"    />-->
        <!--        <result property="createTime"    column="create_time"    />-->
        <!--        <result property="updateBy"    column="update_by"    />-->
        <!--        <result property="updateTime"    column="update_time"    />-->
        <!--        <result property="remark"    column="remark"    />-->
        <!--        <result property="parentName" column="parent_name" />-->
        <!--    </resultMap>-->

        <!--&lt;!&ndash;    <sql id="selectQuestionCategoryVo">&ndash;&gt;-->
        <!--&lt;!&ndash;        select id, parent_id, name, sort, create_by, create_time, update_by, update_time, remark from question_category&ndash;&gt;-->
        <!--&lt;!&ndash;    </sql>&ndash;&gt;-->

        <!--    <sql id="selectQuestionCategoryVo">-->
        <!--        SELECT-->
        <!--            c.id,-->
        <!--            &#45;&#45; 若父类名称不存在（顶级类目），则显示"顶级类目"-->
        <!--            COALESCE(p.name, '顶级类目') AS parent_name,-->
        <!--            c.name AS category_name,-->
        <!--            c.sort,-->
        <!--            c.create_by,-->
        <!--            c.create_time,-->
        <!--            c.update_by,-->
        <!--            c.update_time,-->
        <!--            c.remark-->
        <!--        FROM-->
        <!--            question_category c-->
        <!--                LEFT JOIN-->
        <!--            question_category p-->
        <!--            ON-->
        <!--                c.parent_id = p.id-->
        <!--        ORDER BY-->
        <!--            c.sort ASC,-->
        <!--            c.id ASC;-->
        <!--        </sql>-->

        <!--    <select id="selectQuestionCategoryList" parameterType="com.ruoyi.domain.QuestionCategory" resultMap="QuestionCategoryResult">-->
        <!--        <include refid="selectQuestionCategoryVo"/>-->
        <!--        <where>  -->
        <!--            <if test="parentId != null "> and parent_id = #{parentId}</if>-->
        <!--            <if test="name != null  and name != ''"> and name like concat('%', #{name}, '%')</if>-->
        <!--        </where>-->
        <!--    </select>-->
        <!--    -->
        <!--    <select id="selectQuestionCategoryById" parameterType="Long" resultMap="QuestionCategoryResult">-->
        <!--        <include refid="selectQuestionCategoryVo"/>-->
        <!--        where id = #{id}-->
        <!--    </select>-->

        <!--    <insert id="insertQuestionCategory" parameterType="com.ruoyi.domain.QuestionCategory" useGeneratedKeys="true" keyProperty="id">-->
        <!--        insert into question_category-->
        <!--        <trim prefix="(" suffix=")" suffixOverrides=",">-->
        <!--            <if test="parentId != null">parent_id,</if>-->
        <!--            <if test="name != null and name != ''">name,</if>-->
        <!--            <if test="sort != null">sort,</if>-->
        <!--            <if test="createBy != null and createBy != ''">create_by,</if>-->
        <!--            <if test="createTime != null">create_time,</if>-->
        <!--            <if test="updateBy != null">update_by,</if>-->
        <!--            <if test="updateTime != null">update_time,</if>-->
        <!--            <if test="remark != null">remark,</if>-->
        <!--         </trim>-->
        <!--        <trim prefix="values (" suffix=")" suffixOverrides=",">-->
        <!--            <if test="parentId != null">#{parentId},</if>-->
        <!--            <if test="name != null and name != ''">#{name},</if>-->
        <!--            <if test="sort != null">#{sort},</if>-->
        <!--            <if test="createBy != null and createBy != ''">#{createBy},</if>-->
        <!--            <if test="createTime != null">#{createTime},</if>-->
        <!--            <if test="updateBy != null">#{updateBy},</if>-->
        <!--            <if test="updateTime != null">#{updateTime},</if>-->
        <!--            <if test="remark != null">#{remark},</if>-->
        <!--         </trim>-->
        <!--    </insert>-->

        <!--    <update id="updateQuestionCategory" parameterType="com.ruoyi.domain.QuestionCategory">-->
        <!--        update question_category-->
        <!--        <trim prefix="SET" suffixOverrides=",">-->
        <!--            <if test="parentId != null">parent_id = #{parentId},</if>-->
        <!--            <if test="name != null and name != ''">name = #{name},</if>-->
        <!--            <if test="sort != null">sort = #{sort},</if>-->
        <!--            <if test="createBy != null and createBy != ''">create_by = #{createBy},</if>-->
        <!--            <if test="createTime != null">create_time = #{createTime},</if>-->
        <!--            <if test="updateBy != null">update_by = #{updateBy},</if>-->
        <!--            <if test="updateTime != null">update_time = #{updateTime},</if>-->
        <!--            <if test="remark != null">remark = #{remark},</if>-->
        <!--        </trim>-->
        <!--        where id = #{id}-->
        <!--    </update>-->

        <!--    <delete id="deleteQuestionCategoryById" parameterType="Long">-->
        <!--        delete from question_category where id = #{id}-->
        <!--    </delete>-->

        <!--    <delete id="deleteQuestionCategoryByIds" parameterType="String">-->
        <!--        delete from question_category where id in -->
        <!--        <foreach item="id" collection="array" open="(" separator="," close=")">-->
        <!--            #{id}-->
        <!--        </foreach>-->
        <!--    </delete>-->
        <!--</mapper>-->
